{% extends "base.html" %}
{% block title %}å®å¡”é¢æ¿ - DB Backup Bot{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold">å®å¡”é¢æ¿ç®¡ç†</h1>
        <button onclick="openPanelModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
            + æ·»åŠ é¢æ¿
        </button>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        {% if panels %}
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr class="text-left text-gray-600 text-sm">
                    <th class="px-6 py-3">åç§°</th>
                    <th class="px-6 py-3">é¢æ¿åœ°å€</th>
                    <th class="px-6 py-3">çŠ¶æ€</th>
                    <th class="px-6 py-3">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for panel in panels %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">{{ panel.name }}</td>
                    <td class="px-6 py-4 text-gray-600">{{ panel.url }}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs {% if panel.enabled %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-500{% endif %}">
                            {{ 'å¯ç”¨' if panel.enabled else 'ç¦ç”¨' }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="testPanel({{ panel.id }})" class="text-blue-500 hover:underline text-sm">æµ‹è¯•</button>
                            <button onclick="showDatabases({{ panel.id }}, '{{ panel.name }}')" class="text-green-600 hover:underline text-sm">æ•°æ®åº“</button>
                            <button onclick="editPanel({{ panel.id }})" class="text-gray-600 hover:underline text-sm">ç¼–è¾‘</button>
                            <button onclick="deletePanel({{ panel.id }})" class="text-red-500 hover:underline text-sm">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="p-12 text-center text-gray-500">
            <p class="text-lg mb-4">æš‚æ— å®å¡”é¢æ¿é…ç½®</p>
            <p class="text-sm mb-4">æ·»åŠ å®å¡”é¢æ¿åï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨æœåŠ¡å™¨ä¸Šçš„å¤‡ä»½åŠŸèƒ½</p>
            <button onclick="openPanelModal()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                æ·»åŠ å®å¡”é¢æ¿
            </button>
        </div>
        {% endif %}
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ“– å¦‚ä½•è·å–å®å¡” API å¯†é’¥</h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-600">
            <li>ç™»å½•å®å¡”é¢æ¿</li>
            <li>ç‚¹å‡»å·¦ä¾§èœå•ã€Œè®¾ç½®ã€</li>
            <li>æ‰¾åˆ°ã€ŒAPIæ¥å£ã€é€‰é¡¹</li>
            <li>å¼€å¯ API æ¥å£</li>
            <li>æ·»åŠ  IP ç™½åå•ï¼ˆæ·»åŠ ä½ å½“å‰ç”µè„‘çš„å…¬ç½‘ IPï¼‰</li>
            <li>å¤åˆ¶ API å¯†é’¥</li>
        </ol>
        <p class="mt-4 text-sm text-yellow-600">âš ï¸ æ³¨æ„ï¼šéœ€è¦å°†ä½ çš„å…¬ç½‘ IP æ·»åŠ åˆ°ç™½åå•æ‰èƒ½è°ƒç”¨ API</p>
    </div>
</div>

<!-- é¢æ¿é…ç½®å¼¹çª— -->
<div id="panelModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="panelModalTitle">æ·»åŠ å®å¡”é¢æ¿</h3>
            <button onclick="closePanelModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <form id="panelForm" class="p-4 space-y-4">
            <input type="hidden" id="panelId">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">åç§°</label>
                <input type="text" id="panelName" required placeholder="ä¾‹å¦‚ï¼šä¸»æœåŠ¡å™¨"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">é¢æ¿åœ°å€</label>
                <input type="text" id="panelUrl" required placeholder="http://IP:ç«¯å£"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                <p class="text-xs text-gray-500 mt-1">ä¾‹å¦‚ï¼šhttp://104.250.137.18:8888</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API å¯†é’¥</label>
                <input type="password" id="panelApiKey" placeholder="ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
                <select id="panelEnabled"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    <option value="true">å¯ç”¨</option>
                    <option value="false">ç¦ç”¨</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closePanelModal()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    å–æ¶ˆ
                </button>
                <button type="submit" 
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<!-- æ•°æ®åº“åˆ—è¡¨å¼¹çª— -->
<div id="dbListModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 max-h-[80vh] flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold"><span id="dbListPanelName"></span> - æ•°æ®åº“åˆ—è¡¨</h3>
            <button onclick="closeDbListModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto flex-1" id="dbListContent">
            <div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<!-- å®šæ—¶å¤‡ä»½è®¾ç½®å¼¹çª— -->
<div id="scheduleModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold">å®šæ—¶å¤‡ä»½è®¾ç½® - <span id="scheduleDbName"></span></h3>
            <button onclick="closeScheduleModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <form id="scheduleForm" class="p-4 space-y-4">
            <input type="hidden" id="scheduleConfigId">
            <input type="hidden" id="schedulePanelId">
            <input type="hidden" id="scheduleBtDbId">
            <input type="hidden" id="scheduleDbNameHidden">
            
            <div class="flex items-center">
                <input type="checkbox" id="scheduleEnabled" class="mr-2">
                <label class="text-sm font-medium text-gray-700">å¯ç”¨å®šæ—¶å¤‡ä»½</label>
            </div>
            
            <div id="scheduleOptions" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡ä»½é¢‘ç‡</label>
                    <select id="scheduleType"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="minutes">æ¯Nåˆ†é’Ÿ</option>
                        <option value="hourly">æ¯å°æ—¶</option>
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯å‘¨</option>
                    </select>
                </div>
                
                <div id="minutesWrapper">
                    <label class="block text-sm font-medium text-gray-700 mb-1">é—´éš”åˆ†é’Ÿæ•°</label>
                    <input type="number" id="scheduleMinutes" value="30" min="1" max="1440"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    <p class="text-xs text-gray-500 mt-1">ä¾‹å¦‚ï¼š30 è¡¨ç¤ºæ¯30åˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡</p>
                </div>
                
                <div id="timeWrapper" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡ä»½æ—¶é—´</label>
                    <input type="time" id="scheduleTime" value="03:00"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                </div>
                
                <div id="weeklyDayWrapper" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ˜ŸæœŸ</label>
                    <select id="scheduleDay"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        <option value="0">å‘¨ä¸€</option>
                        <option value="1">å‘¨äºŒ</option>
                        <option value="2">å‘¨ä¸‰</option>
                        <option value="3">å‘¨å››</option>
                        <option value="4">å‘¨äº”</option>
                        <option value="5">å‘¨å…­</option>
                        <option value="6">å‘¨æ—¥</option>
                    </select>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="pushToTg" checked class="mr-2">
                    <label class="text-sm font-medium text-gray-700">å¤‡ä»½å®Œæˆåæ¨é€æ–‡ä»¶åˆ° Telegram</label>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeScheduleModal()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    å–æ¶ˆ
                </button>
                <button type="submit" 
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const panelModal = document.getElementById('panelModal');
const dbListModal = document.getElementById('dbListModal');
const scheduleModal = document.getElementById('scheduleModal');
const panelForm = document.getElementById('panelForm');
const scheduleForm = document.getElementById('scheduleForm');
let currentPanelId = null;
let btDatabaseConfigs = {};  // ç¼“å­˜å·²é…ç½®çš„å®šæ—¶å¤‡ä»½

function openPanelModal(data = null) {
    if (data) {
        document.getElementById('panelModalTitle').textContent = 'ç¼–è¾‘å®å¡”é¢æ¿';
        document.getElementById('panelId').value = data.id;
        document.getElementById('panelName').value = data.name;
        document.getElementById('panelUrl').value = data.url;
        document.getElementById('panelApiKey').value = '';
        document.getElementById('panelApiKey').placeholder = 'ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹';
        document.getElementById('panelEnabled').value = data.enabled ? 'true' : 'false';
    } else {
        document.getElementById('panelModalTitle').textContent = 'æ·»åŠ å®å¡”é¢æ¿';
        panelForm.reset();
        document.getElementById('panelId').value = '';
        document.getElementById('panelApiKey').placeholder = 'API å¯†é’¥';
    }
    panelModal.classList.add('active');
}

function closePanelModal() {
    panelModal.classList.remove('active');
}

function closeDbListModal() {
    dbListModal.classList.remove('active');
}

function closeScheduleModal() {
    scheduleModal.classList.remove('active');
}

document.getElementById('scheduleEnabled').addEventListener('change', function() {
    document.getElementById('scheduleOptions').style.opacity = this.checked ? '1' : '0.5';
});

document.getElementById('scheduleType').addEventListener('change', function() {
    const type = this.value;
    document.getElementById('minutesWrapper').classList.toggle('hidden', type !== 'minutes');
    document.getElementById('timeWrapper').classList.toggle('hidden', type === 'minutes');
    document.getElementById('weeklyDayWrapper').classList.toggle('hidden', type !== 'weekly');
});

async function editPanel(id) {
    const panels = await api('/api/bt-panels');
    const panel = panels.find(p => p.id === id);
    if (panel) openPanelModal(panel);
}

async function deletePanel(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢æ¿é…ç½®ï¼Ÿ')) return;
    await api(`/api/bt-panels/${id}`, 'DELETE');
    showToast('åˆ é™¤æˆåŠŸ');
    location.reload();
}

async function testPanel(id) {
    showToast('æµ‹è¯•è¿æ¥ä¸­...');
    const result = await api(`/api/bt-panels/${id}/test`, 'POST');
    
    if (result.success) {
        showToast('è¿æ¥æˆåŠŸï¼');
    } else {
        showToast('è¿æ¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
}

async function showDatabases(id, name) {
    currentPanelId = id;
    document.getElementById('dbListPanelName').textContent = name;
    document.getElementById('dbListContent').innerHTML = '<div class="text-center text-gray-500 py-8">åŠ è½½ä¸­...</div>';
    dbListModal.classList.add('active');
    
    // è·å–å·²é…ç½®çš„å®šæ—¶å¤‡ä»½
    const configs = await api('/api/bt-databases');
    btDatabaseConfigs = {};
    configs.forEach(c => {
        if (c.panel_id === id) {
            btDatabaseConfigs[c.bt_db_id] = c;
        }
    });
    
    const result = await api(`/api/bt-panels/${id}/databases`);
    
    if (result.data && result.data.length > 0) {
        let html = '<div class="space-y-2">';
        for (const db of result.data) {
            const config = btDatabaseConfigs[db.id];
            const scheduleInfo = config && config.schedule_enabled 
                ? `<span class="text-green-600 text-xs ml-2">â° ${config.schedule_type} @ ${config.schedule_time}</span>`
                : '';
            
            html += `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100">
                    <div>
                        <div class="font-medium">${db.name} ${scheduleInfo}</div>
                        <div class="text-sm text-gray-500">ç”¨æˆ·: ${db.username}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="openSchedule(${db.id}, '${db.name}')" 
                            class="px-3 py-1 border border-gray-300 text-gray-600 text-sm rounded hover:bg-gray-200">
                            â° å®šæ—¶
                        </button>
                        <button onclick="backupBtDb(${db.id}, '${db.name}')" 
                            class="px-3 py-1 bg-primary text-white text-sm rounded hover:bg-blue-600">
                            å¤‡ä»½
                        </button>
                    </div>
                </div>
            `;
        }
        html += '</div>';
        document.getElementById('dbListContent').innerHTML = html;
    } else {
        document.getElementById('dbListContent').innerHTML = 
            '<div class="text-center text-gray-500 py-8">æš‚æ— æ•°æ®åº“æˆ–è·å–å¤±è´¥<br><span class="text-sm">è¯·æ£€æŸ¥ API å¯†é’¥å’Œ IP ç™½åå•</span></div>';
    }
}

function openSchedule(btDbId, dbName) {
    document.getElementById('scheduleDbName').textContent = dbName;
    document.getElementById('schedulePanelId').value = currentPanelId;
    document.getElementById('scheduleBtDbId').value = btDbId;
    document.getElementById('scheduleDbNameHidden').value = dbName;
    
    const config = btDatabaseConfigs[btDbId];
    if (config) {
        document.getElementById('scheduleConfigId').value = config.id;
        document.getElementById('scheduleEnabled').checked = config.schedule_enabled;
        document.getElementById('scheduleType').value = config.schedule_type;
        document.getElementById('scheduleTime').value = config.schedule_time;
        document.getElementById('scheduleDay').value = config.schedule_day;
        document.getElementById('scheduleMinutes').value = config.schedule_minutes || 30;
        document.getElementById('pushToTg').checked = config.push_to_tg;
    } else {
        document.getElementById('scheduleConfigId').value = '';
        document.getElementById('scheduleEnabled').checked = false;
        document.getElementById('scheduleType').value = 'minutes';
        document.getElementById('scheduleTime').value = '03:00';
        document.getElementById('scheduleDay').value = '0';
        document.getElementById('scheduleMinutes').value = '30';
        document.getElementById('pushToTg').checked = true;
    }
    
    const type = document.getElementById('scheduleType').value;
    document.getElementById('scheduleOptions').style.opacity = document.getElementById('scheduleEnabled').checked ? '1' : '0.5';
    document.getElementById('minutesWrapper').classList.toggle('hidden', type !== 'minutes');
    document.getElementById('timeWrapper').classList.toggle('hidden', type === 'minutes');
    document.getElementById('weeklyDayWrapper').classList.toggle('hidden', type !== 'weekly');
    
    scheduleModal.classList.add('active');
}

async function backupBtDb(dbId, dbName) {
    if (!confirm(`ç¡®å®šè¦å¤‡ä»½æ•°æ®åº“ ${dbName}ï¼Ÿ`)) return;
    
    showToast('æ­£åœ¨æ‰§è¡Œå¤‡ä»½...');
    
    const result = await api(`/api/bt-panels/${currentPanelId}/backup`, 'POST', {
        db_id: dbId,
        db_name: dbName,
        push_to_tg: true
    });
    
    if (result.success) {
        showToast('å¤‡ä»½æˆåŠŸï¼æ–‡ä»¶å·²æ¨é€åˆ° Telegram');
    } else {
        showToast('å¤‡ä»½å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
}

panelForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        name: document.getElementById('panelName').value,
        url: document.getElementById('panelUrl').value,
        api_key: document.getElementById('panelApiKey').value,
        enabled: document.getElementById('panelEnabled').value === 'true'
    };
    
    const id = document.getElementById('panelId').value;
    
    if (id) {
        await api(`/api/bt-panels/${id}`, 'PUT', data);
        showToast('æ›´æ–°æˆåŠŸ');
    } else {
        if (!data.api_key) {
            showToast('è¯·è¾“å…¥ API å¯†é’¥', 'error');
            return;
        }
        await api('/api/bt-panels', 'POST', data);
        showToast('æ·»åŠ æˆåŠŸ');
    }
    
    closePanelModal();
    location.reload();
});

scheduleForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        panel_id: parseInt(document.getElementById('schedulePanelId').value),
        bt_db_id: parseInt(document.getElementById('scheduleBtDbId').value),
        db_name: document.getElementById('scheduleDbNameHidden').value,
        schedule_enabled: document.getElementById('scheduleEnabled').checked,
        schedule_type: document.getElementById('scheduleType').value,
        schedule_time: document.getElementById('scheduleTime').value,
        schedule_day: parseInt(document.getElementById('scheduleDay').value),
        schedule_minutes: parseInt(document.getElementById('scheduleMinutes').value),
        push_to_tg: document.getElementById('pushToTg').checked
    };
    
    const configId = document.getElementById('scheduleConfigId').value;
    
    if (configId) {
        await api(`/api/bt-databases/${configId}`, 'PUT', data);
    } else {
        await api('/api/bt-databases', 'POST', data);
    }
    
    showToast('å®šæ—¶å¤‡ä»½è®¾ç½®å·²ä¿å­˜');
    closeScheduleModal();
    showDatabases(currentPanelId, document.getElementById('dbListPanelName').textContent);
});
</script>
{% endblock %}
